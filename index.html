<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#FB8C00"/>
    <link rel="manifest" href="manifest.json">
    <title>Saral Upasthiti</title>
    <style>
        :root {
            --primary-color: #FB8C00; /* Orange */
            --secondary-color: #4CAF50; /* Green */
            --accent-color: #1976D2; /* Blue for management */
            --danger-color: #D32F2F; /* Red for delete */
            --light-gray: #f5f5f5;
            --dark-text: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            background-color: var(--light-gray);
            color: var(--dark-text);
            overscroll-behavior-y: contain;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-bar {
            background-color: var(--primary-color);
            color: white;
            padding: 16px;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-bar .back-button, .app-bar .icon-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 8px;
        }
        
        .app-bar-title {
           flex-grow: 1;
        }
        
        .app-bar-subtitle {
            font-size: 0.9rem;
            font-weight: normal;
            opacity: 0.9;
        }
        
        .app-bar-date-input {
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .screen {
            display: none;
            flex-grow: 1;
            background-color: white;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }
        
        .screen-content {
            padding-bottom: 80px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .auth-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            background-color: var(--light-gray);
        }
        
        .auth-container {
            width: 100%;
            max-width: 350px;
            padding: 24px;
            box-sizing: border-box;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .auth-container h1 {
             color: var(--primary-color);
             text-align: center;
             margin-top: 0;
             margin-bottom: 24px;
        }
        
        .auth-container p {
            text-align: center;
            margin-top: 16px;
        }
        .auth-container p a {
            color: var(--primary-color);
            font-weight: bold;
            cursor: pointer;
        }

        .list {
            list-style: none;
            padding: 8px;
            margin: 0;
        }

        .list-item {
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .list-item-clickable {
            cursor: pointer;
        }

        .list-item-clickable:hover {
            background-color: #f9f9f9;
        }
        
        .list-item .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #FFF3E0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .list-item .title {
            font-weight: bold;
            flex-grow: 1;
        }
        
        .student-item input[type="checkbox"] {
            transform: scale(1.5);
            margin-left: 16px;
            accent-color: var(--primary-color);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        .btn:hover {
            opacity: 0.9;
        }

        .btn.gemini-btn {
            background: linear-gradient(45deg, #4285F4, #9B72CB, #D96570, #F2A60C);
            margin-top: 16px;
        }

        .btn.manage-btn { background-color: var(--accent-color); font-size: 0.9rem; padding: 8px 12px; margin-left: 10px; width: auto; }
        .btn.delete-btn { background-color: var(--danger-color); font-size: 0.9rem; padding: 8px 12px; margin-left: 10px; width: auto; }

        .action-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 560px;
            padding: 16px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .action-button.save-btn { background-color: var(--secondary-color); }
        .action-button.add-class-btn { background-color: var(--accent-color); }

        .sync-container {
            padding: 10px 16px;
            background-color: #fff3e0;
            border-bottom: 1px solid #ffe0b2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sync-container button {
            background-color: var(--accent-color);
            color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer;
        }
        .sync-container span {
            font-size: 0.9rem;
        }

        /* Report Screen Styles */
        .report-summary {
            padding: 16px;
            display: flex;
            justify-content: space-around;
            text-align: center;
            background-color: #f7f7f7;
            border-bottom: 1px solid #eee;
        }
        .report-summary-item { padding: 8px; }
        .report-summary-item .value { font-size: 1.5rem; font-weight: bold; }
        .report-summary-item .label { font-size: 0.9rem; color: #555; }
        .report-summary-item .value.green { color: var(--secondary-color); }
        .report-summary-item .value.red { color: var(--danger-color); }
        #geminiActionContainer { padding: 0 16px 16px 16px; border-bottom: 1px solid #eee;}

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); display: none; align-items: center;
            justify-content: center; z-index: 2000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background-color: white; padding: 24px; border-radius: 12px;
            width: calc(100% - 40px); max-width: 400px; text-align: center;
        }
        .modal-content h3 { margin-top: 0; }
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group textarea {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem;
        }
        .modal-actions {
            display: flex; justify-content: center; gap: 10px; margin-top: 24px;
        }
        .modal-actions .btn-secondary { background-color: #ccc; }
        .modal-actions .btn-danger { background-color: var(--danger-color); }
        #geminiResultContent {
            background-color: var(--light-gray);
            padding: 16px;
            border-radius: 8px;
            text-align: left;
            white-space: pre-wrap;
            max-height: 40vh;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        .toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: #333; color: white; padding: 12px 24px;
            border-radius: 8px; transition: bottom 0.5s ease; z-index: 3000;
        }
        .toast.show { bottom: 30px; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- ===== Auth Screen ===== -->
        <div id="authScreen" class="screen active auth-screen">
             <div id="loginContainer" class="auth-container">
                <h1>Welcome Back!</h1>
                <form id="loginForm" style="width: 100%;">
                    <div class="form-group">
                        <label for="loginTeacherId">Teacher ID</label>
                        <input type="text" id="loginTeacherId" placeholder="Enter your registered ID" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
                <p>Don't have an account? <a id="showSignUpLink">Sign Up</a></p>
            </div>

            <div id="signUpContainer" class="auth-container" style="display: none;">
                <h1>Create Account</h1>
                <form id="signUpForm" style="width: 100%;">
                    <div class="form-group">
                        <label for="signUpTeacherId">Choose a Teacher ID</label>
                        <input type="text" id="signUpTeacherId" placeholder="e.g., Anurag_singh" required>
                    </div>
                     <div class="form-group">
                        <label for="signUpPassword">Choose a Password</label>
                        <input type="password" id="signUpPassword" placeholder="Minimum 6 characters" required>
                    </div>
                    <button type="submit" class="btn">Sign Up</button>
                </form>
                <p>Already have an account? <a id="showLoginLink">Login</a></p>
            </div>
        </div>
        
        <!-- ===== Home Screen ===== -->
        <div id="homeScreen" class="screen">
            <header class="app-bar">
                <div class="app-bar-title">My Classes</div>
                <button id="logoutBtn" class="icon-button" title="Logout">&#10162;</button> <!-- Logout Symbol -->
            </header>
            <div class="sync-container">
                <span id="syncStatus">Ready to sync.</span>
                <button id="syncBtn">Sync Data</button>
            </div>
            <main class="screen-content">
                <ul id="classList" class="list"></ul>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <h3>No Classes Found</h3>
                    <p>Tap below to add your first class.</p>
                    <button id="addFirstClassBtn" class="btn" style="width: auto;">Add New Class</button>
                </div>
            </main>
            <button id="addClassBtn" class="action-button add-class-btn" style="display: none;">+ Add New Class</button>
        </div>

        <!-- ===== Management Screen ===== -->
        <div id="managementScreen" class="screen">
            <header class="app-bar">
                <button class="back-button">&larr;</button>
                <div class="app-bar-title">
                    <span id="manageClassName"></span>
                    <div class="app-bar-subtitle">Manage Students</div>
                </div>
            </header>
            <main class="screen-content"><ul id="managementStudentList" class="list"></ul></main>
            <button id="addStudentBtn" class="action-button add-class-btn">+ Add New Student</button>
        </div>
        
        <!-- ===== Report Screen ===== -->
        <div id="reportScreen" class="screen">
             <header class="app-bar">
                <button class="back-button">&larr;</button>
                <div class="app-bar-title">
                    <span id="reportStudentName"></span>
                    <div class="app-bar-subtitle">Attendance Report</div>
                </div>
            </header>
            <main class="screen-content">
                <div id="reportSummary" class="report-summary"></div>
                <div id="geminiActionContainer"></div>
                <ul id="reportDateList" class="list"></ul>
            </main>
        </div>

        <!-- ===== Attendance Screen ===== -->
        <div id="attendanceScreen" class="screen">
            <header class="app-bar">
                <button class="back-button">&larr;</button>
                <div class="app-bar-title">
                    <span id="attendanceClassName"></span>
                    <div><input type="date" id="attendanceDate" class="app-bar-date-input"></div>
                </div>
            </header>
            <main class="screen-content">
                <ul id="attendanceStudentList" class="list"></ul>
                 <div id="emptyAttendanceState" class="empty-state" style="display: none;">
                    <h3>No Students to Mark</h3>
                    <p>Add students in the management screen first.</p>
                </div>
            </main>
            <button id="saveAttendanceBtn" class="action-button save-btn">SAVE ATTENDANCE</button>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="addClassModal" class="modal-overlay">
        <div class="modal-content" style="text-align: left;">
            <h3>Add New Class</h3>
            <form id="addClassForm">
                <div class="form-group">
                    <label for="newClassName">Class Name</label>
                    <input type="text" id="newClassName" placeholder="e.g., Class 6 - Section B" required>
                </div>
                <div class="modal-actions" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelAddClass">Cancel</button>
                    <button type="submit" class="btn" style="width: auto;">Save Class</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addStudentModal" class="modal-overlay">
        <div class="modal-content" style="text-align: left;">
            <h3>Add New Student</h3>
            <form id="addStudentForm">
                <div class="form-group">
                    <label for="newStudentName">Student Name</label>
                    <input type="text" id="newStudentName" placeholder="e.g., Anurag Singh" required>
                </div>
                <div class="form-group">
                    <label for="newStudentRoll">Roll Number</label>
                    <input type="number" id="newStudentRoll" placeholder="e.g., 15" required>
                </div>
                <div class="modal-actions" style="justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelAddStudent">Cancel</button>
                    <button type="submit" class="btn" style="width: auto;">Save Student</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirmDeleteModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirm Student Deletion</h3>
            <p>Are you sure you want to delete this student? All their attendance records will also be removed.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelDeleteStudent">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteStudentBtn" style="width: auto;">Delete</button>
            </div>
        </div>
    </div>

    <div id="confirmDeleteClassModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Confirm Class Deletion</h3>
            <p>Are you sure? Deleting this class will also delete ALL its students and their attendance records permanently.</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelDeleteClass">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteClassBtn" style="width: auto;">Delete Class</button>
            </div>
        </div>
    </div>

    <div id="geminiResultModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="geminiResultTitle">✨ AI Generated Content</h3>
            <div id="geminiLoader" class="loader" style="display: none;"></div>
            <div id="geminiResultContent" style="display: none;"></div>
            <textarea id="copyHelper" style="opacity: 0; position: absolute; left: -9999px;"></textarea>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="closeGeminiModal">Close</button>
                <button type="button" class="btn" id="copyGeminiResultBtn" style="width: auto;">Copy Text</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <script>
        // --- PWA Service Worker and Manifest Setup ---
        const manifest = {
            "name": "Saral Upasthiti",
            "short_name": "Upasthiti",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#FB8C00",
            "theme_color": "#FB8C00",
            "description": "An offline-first attendance app.",
            "icons": [{
                "src": "https://www.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png",
                "sizes": "48x48",
                "type": "image/png"
            }, {
                "src": "https://www.gstatic.com/images/branding/product/1x/drive_2020q4_96dp.png",
                "sizes": "96x96",
                "type": "image/png"
            }, {
                "src": "https://www.gstatic.com/images/branding/product/1x/drive_2020q4_192dp.png",
                "sizes": "192x192",
                "type": "image/png"
            }]
        };

        const serviceWorkerCode = `
            const CACHE_NAME = 'saral-upasthiti-cache-v1';
            const URLS_TO_CACHE = [
                './' 
            ];

            self.addEventListener('install', event => {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            return cache.addAll(URLS_TO_CACHE);
                        })
                );
            });

            self.addEventListener('fetch', event => {
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            return response || fetch(event.request);
                        })
                );
            });
        `;
        
        // Dynamically create and link manifest
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.querySelector('head').insertAdjacentHTML('beforeend', `<link rel="manifest" href="${manifestUrl}">`);

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            const swBlob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(swBlob);
            navigator.serviceWorker.register(swUrl)
                .then(registration => console.log('Service Worker registered with scope:', registration.scope))
                .catch(error => console.log('Service Worker registration failed:', error));
        }


        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const screens = {
                auth: document.getElementById('authScreen'),
                home: document.getElementById('homeScreen'),
                management: document.getElementById('managementScreen'),
                attendance: document.getElementById('attendanceScreen'),
                report: document.getElementById('reportScreen'),
            };

            const modals = {
                addClass: document.getElementById('addClassModal'),
                addStudent: document.getElementById('addStudentModal'),
                confirmDelete: document.getElementById('confirmDeleteModal'),
                confirmDeleteClass: document.getElementById('confirmDeleteClassModal'),
                geminiResult: document.getElementById('geminiResultModal'),
            };

            // Auth Screen Elements
            const loginContainer = document.getElementById('loginContainer');
            const signUpContainer = document.getElementById('signUpContainer');
            const loginForm = document.getElementById('loginForm');
            const signUpForm = document.getElementById('signUpForm');
            const showSignUpLink = document.getElementById('showSignUpLink');
            const showLoginLink = document.getElementById('showLoginLink');

            // Gemini Elements
            const geminiActionContainer = document.getElementById('geminiActionContainer');
            const geminiLoader = document.getElementById('geminiLoader');
            const geminiResultContent = document.getElementById('geminiResultContent');
            const copyGeminiResultBtn = document.getElementById('copyGeminiResultBtn');

            // Buttons & Interactive Elements
            const logoutBtn = document.getElementById('logoutBtn');
            const syncBtn = document.getElementById('syncBtn');
            const syncStatus = document.getElementById('syncStatus');
            const classList = document.getElementById('classList');
            const emptyState = document.getElementById('emptyState');
            const manageClassName = document.getElementById('manageClassName');
            const managementStudentList = document.getElementById('managementStudentList');
            const attendanceClassName = document.getElementById('attendanceClassName');
            const attendanceDateEl = document.getElementById('attendanceDate');
            const attendanceStudentList = document.getElementById('attendanceStudentList');
            const emptyAttendanceState = document.getElementById('emptyAttendanceState');
            const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
            const toastEl = document.getElementById('toast');
            
            // Report Screen Elements
            const reportStudentName = document.getElementById('reportStudentName');
            const reportSummary = document.getElementById('reportSummary');
            const reportDateList = document.getElementById('reportDateList');

            // Forms
            const addClassForm = document.getElementById('addClassForm');
            const addStudentForm = document.getElementById('addStudentForm');

            let currentClassId = null;
            let studentToDeleteId = null;
            let classToDeleteId = null;
            let currentTeacherId = null;

            // --- Database Abstraction ---
            const db = {
                // Local device storage, unique to each teacher
                getLocal: (key) => JSON.parse(localStorage.getItem(`${key}_${currentTeacherId}`) || '[]'),
                setLocal: (key, data) => localStorage.setItem(`${key}_${currentTeacherId}`, JSON.stringify(data)),
                // Fake server storage, unique to each teacher
                getServer: (key) => JSON.parse(localStorage.getItem(`server_${key}_${currentTeacherId}`) || '[]'),
                setServer: (key, data) => localStorage.setItem(`server_${key}_${currentTeacherId}`, JSON.stringify(data)),
                // Global registry of all teachers with their passwords
                getTeacherRegistry: () => JSON.parse(localStorage.getItem('saral_teacher_registry') || '[]'),
                setTeacherRegistry: (data) => localStorage.setItem('saral_teacher_registry', JSON.stringify(data)),
            };
            
            // --- Navigation & State ---
            function navigateTo(screenName, contextId = null) {
                currentClassId = contextId;
                Object.values(screens).forEach(s => s.classList.remove('active'));
                screens[screenName].classList.add('active');
            }

            // --- Modal Controls ---
            function showModal(modalName) { modals[modalName].classList.add('active'); }
            function hideModals() { Object.values(modals).forEach(m => m.classList.remove('active')); }
            
            // --- UI Rendering ---
            function renderHomeScreen() {
                const classes = db.getLocal('classes');
                classList.innerHTML = '';
                
                if (classes.length === 0) {
                    emptyState.style.display = 'block';
                    document.getElementById('addClassBtn').style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    document.getElementById('addClassBtn').style.display = 'block';
                    classes.forEach(cls => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.innerHTML = `
                            <div class="icon list-item-clickable" onclick="showAttendanceScreen(${cls.id})">🏫</div>
                            <span class="title list-item-clickable" onclick="showAttendanceScreen(${cls.id})">${cls.name}</span>
                            <button class="btn manage-btn" data-class-id="${cls.id}">Manage</button>
                            <button class="btn delete-btn" data-class-id="${cls.id}">Delete</button>
                        `;

                        li.querySelector('.manage-btn').onclick = (e) => showManagementScreen(parseInt(e.target.dataset.classId));
                        li.querySelector('.delete-btn').onclick = (e) => {
                            classToDeleteId = parseInt(e.target.dataset.classId);
                            showModal('confirmDeleteClass');
                        };
                        classList.appendChild(li);
                    });
                }
            }
            
            window.showAttendanceScreen = function(classId){
                 navigateTo('attendance', classId);
                 renderAttendanceScreen(classId);
            }

            function renderManagementScreen(classId) {
                currentClassId = classId;
                const selectedClass = db.getLocal('classes').find(c => c.id === classId);
                
                if (!selectedClass) {
                    showToast("Error: Class not found.");
                    navigateTo('home');
                    return;
                }

                const studentsInClass = db.getLocal('students').filter(s => s.class_id === classId);
                
                manageClassName.textContent = selectedClass.name;
                managementStudentList.innerHTML = '';

                if (studentsInClass.length === 0) {
                    managementStudentList.innerHTML = `<div class="empty-state"><p>No students found. Add one below.</p></div>`;
                } else {
                    studentsInClass.sort((a, b) => a.roll_number - b.roll_number).forEach(student => {
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.innerHTML = `
                            <div class="icon">${student.roll_number}</div>
                            <div class="title list-item-clickable" style="flex-grow:1" onclick="showReportScreen(${student.id})">${student.name}</div>
                            <button class="btn delete-btn" data-student-id="${student.id}">Delete</button>
                        `;
                        li.querySelector('.delete-btn').onclick = (e) => {
                            studentToDeleteId = parseInt(e.target.dataset.studentId);
                            showModal('confirmDelete');
                        };
                        managementStudentList.appendChild(li);
                    });
                }
            }
            
            window.showReportScreen = function(studentId) {
                navigateTo('report');
                renderReportScreen(studentId);
            }

            function renderReportScreen(studentId) {
                const student = db.getLocal('students').find(s => s.id === studentId);
                 if (!student) {
                    showToast("Error: Student not found.");
                    navigateTo('home');
                    return;
                }
                const selectedClass = db.getLocal('classes').find(c => c.id === student.class_id);
                const allAttendance = db.getLocal('attendance');
                
                const classStudentIds = db.getLocal('students')
                    .filter(s => s.class_id === student.class_id)
                    .map(s => s.id);

                const lectureDates = [...new Set(allAttendance
                    .filter(att => classStudentIds.includes(att.student_id))
                    .map(att => att.date))];
                
                const totalLectures = lectureDates.length;
                const studentAttendanceRecords = allAttendance.filter(att => att.student_id === studentId);
                const attendedLectures = studentAttendanceRecords.filter(att => att.status === 'Present').length;
                const percentage = totalLectures === 0 ? 0 : (attendedLectures / totalLectures) * 100;
                
                reportStudentName.textContent = student.name;
                reportSummary.innerHTML = `
                    <div class="report-summary-item">
                        <div class="value">${totalLectures}</div>
                        <div class="label">Total Lectures</div>
                    </div>
                    <div class="report-summary-item">
                        <div class="value green">${attendedLectures}</div>
                        <div class="label">Attended</div>
                    </div>
                    <div class="report-summary-item">
                        <div class="value ${percentage < 75 ? 'red' : 'green'}">${percentage.toFixed(1)}%</div>
                        <div class="label">Percentage</div>
                    </div>
                `;

                // Render Gemini buttons
                geminiActionContainer.innerHTML = `
                    <button id="generateNoteBtn" class="btn gemini-btn">✨ Generate Performance Note</button>
                    <button id="generateSmsBtn" class="btn gemini-btn" style="display: ${percentage < 75 && percentage > 0 ? 'block' : 'none'};">✨ Draft Parent SMS</button>
                `;
                document.getElementById('generateNoteBtn').onclick = () => handleGenerateNote(student, attendedLectures, totalLectures, percentage);
                document.getElementById('generateSmsBtn').onclick = () => handleGenerateSms(student, selectedClass, percentage);
                
                reportDateList.innerHTML = '';
                if(lectureDates.length === 0){
                    reportDateList.innerHTML = `<div class="empty-state"><p>No attendance has been recorded for this class yet.</p></div>`;
                } else {
                    lectureDates.sort((a,b) => b.localeCompare(a)).forEach(date => {
                        const record = studentAttendanceRecords.find(att => att.date === date);
                        const status = record ? record.status : 'N/A';
                        const li = document.createElement('li');
                        li.className = 'list-item';
                        li.innerHTML = `
                            <div class="icon" style="background-color: ${status === 'Present' ? '#E8F5E9' : '#FFEBEE'}; color: ${status === 'Present' ? 'var(--secondary-color)' : 'var(--danger-color)'}">${status.charAt(0)}</div>
                            <span class="title">${new Date(date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                            <span style="font-weight:bold; color: ${status === 'Present' ? 'var(--secondary-color)' : 'var(--danger-color)'}">${status}</span>
                        `;
                        reportDateList.appendChild(li);
                    });
                }
            }


            function renderAttendanceScreen(classId, dateString = new Date().toISOString().slice(0, 10)) {
                currentClassId = classId;
                const selectedClass = db.getLocal('classes').find(c => c.id === classId);
                
                if (!selectedClass) {
                    showToast("Error: Class not found.");
                    navigateTo('home');
                    return;
                }

                attendanceDateEl.value = dateString;

                const studentsInClass = db.getLocal('students').filter(s => s.class_id === classId);
                const allAttendance = db.getLocal('attendance');

                attendanceClassName.textContent = selectedClass.name;
                
                attendanceStudentList.innerHTML = '';
                if(studentsInClass.length === 0){
                    emptyAttendanceState.style.display = 'block';
                    saveAttendanceBtn.style.display = 'none';
                } else {
                    emptyAttendanceState.style.display = 'none';
                    saveAttendanceBtn.style.display = 'block';
                    studentsInClass.sort((a, b) => a.roll_number - b.roll_number).forEach(student => {
                        const attendanceRecord = allAttendance.find(att => att.student_id === student.id && att.date === dateString);
                        const isChecked = attendanceRecord ? attendanceRecord.status === 'Present' : true;

                        const li = document.createElement('li');
                        li.className = 'list-item student-item';
                        li.innerHTML = `
                            <div class="icon">${student.roll_number}</div>
                            <span class="title">${student.name}</span>
                            <input type="checkbox" data-student-id="${student.id}" ${isChecked ? 'checked' : ''}>
                        `;
                        li.addEventListener('click', (e) => {
                            if (e.target.type !== 'checkbox') {
                                const checkbox = li.querySelector('input[type="checkbox"]');
                                checkbox.checked = !checkbox.checked;
                            }
                        });
                        attendanceStudentList.appendChild(li);
                    });
                }
            }

            // --- Gemini API Functions ---
            async function callGeminiAPI(prompt) {
                showModal('geminiResult');
                geminiLoader.style.display = 'block';
                geminiResultContent.style.display = 'none';
                geminiResultContent.textContent = '';
                
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates[0].content.parts[0].text;

                    geminiResultContent.textContent = text.trim();
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    geminiResultContent.textContent = `Error: Could not get a response from the AI. Please check your connection and API key.\n\nDetails: ${error.message}`;
                } finally {
                    geminiLoader.style.display = 'none';
                    geminiResultContent.style.display = 'block';
                }
            }

            function handleGenerateNote(student, attended, total, percentage) {
                const prompt = `Act as a school teacher in India. A student named ${student.name} has an attendance of ${attended} out of ${total} lectures (${percentage.toFixed(1)}%).
                Write a brief, constructive, and encouraging note (2-3 sentences) for their report card based on their attendance.
                - If attendance is above 90%, praise their regularity.
                - If attendance is between 75% and 90%, mention they have good attendance.
                - If attendance is below 75%, express concern and strongly encourage regular attendance for better learning.
                Keep the tone professional and supportive.`;
                callGeminiAPI(prompt);
            }

            function handleGenerateSms(student, s_class, percentage) {
                const prompt = `Act as a school teacher in rural India. A student named ${student.name} from class ${s_class.name} has low attendance (${percentage.toFixed(1)}%).
                Draft a polite and formal SMS in Hindi to send to their parents, informing them of the low attendance and requesting them to meet the teacher.
                Keep the SMS professional and under 160 characters.`;
                callGeminiAPI(prompt);
            }


            // --- Core Logic Functions ---
            async function sendLoginNotification(teacherId) {
                // IMPORTANT: Replace this with your own Formspree URL
                const FORMPSPREE_URL = "https://formspree.io/f/your_unique_code";
                
                if (FORMPSPREE_URL === "https://formspree.io/f/your_unique_code") {
                    console.log("Formspree URL not set. Skipping notification.");
                    return; 
                }

                try {
                    await fetch(FORMPSPREE_URL, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            teacherId: teacherId,
                            loginTime: new Date().toLocaleString('en-IN')
                        })
                    });
                } catch (error) {
                    console.error("Could not send login notification:", error);
                }
            }
            
            function handleLogin(e) {
                e.preventDefault();
                const teacherIdInput = document.getElementById('loginTeacherId');
                const passwordInput = document.getElementById('loginPassword');
                const teacherId = teacherIdInput.value.trim().toLowerCase();
                const password = passwordInput.value;
                
                if (teacherId && password) {
                    const registry = db.getTeacherRegistry();
                    const teacherAccount = registry.find(acc => acc.id === teacherId);

                    if (teacherAccount && teacherAccount.password === password) {
                        currentTeacherId = teacherId;
                        sendLoginNotification(teacherId);
                        navigateTo('home');
                        renderHomeScreen();
                    } else {
                        showToast("Invalid ID or Password.");
                    }
                }
            }
            
            function handleSignUp(e) {
                e.preventDefault();
                const teacherIdInput = document.getElementById('signUpTeacherId');
                const passwordInput = document.getElementById('signUpPassword');
                const teacherId = teacherIdInput.value.trim().toLowerCase();
                const password = passwordInput.value;

                if (password.length < 6) {
                    showToast("Password must be at least 6 characters long.");
                    return;
                }
                
                if (teacherId && password) {
                    const registry = db.getTeacherRegistry();
                    const isIdTaken = registry.some(acc => acc.id === teacherId);

                    if (isIdTaken) {
                        showToast("This ID is already taken. Please choose another.");
                    } else {
                        registry.push({ id: teacherId, password: password });
                        db.setTeacherRegistry(registry);
                        currentTeacherId = teacherId;
                        showToast("Account created successfully!");
                        sendLoginNotification(teacherId + ' (New Signup)');
                        navigateTo('home');
                        renderHomeScreen();
                    }
                }
            }

            function handleLogout() {
                currentTeacherId = null;
                document.getElementById('loginTeacherId').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('signUpTeacherId').value = '';
                document.getElementById('signUpPassword').value = '';
                navigateTo('auth');
            }
            
            function handleSync() {
                syncBtn.disabled = true;
                syncStatus.textContent = 'Syncing...';

                setTimeout(() => {
                    try {
                        const localClasses = db.getLocal('classes');
                        const localStudents = db.getLocal('students');
                        const localAttendance = db.getLocal('attendance');
                        db.setServer('classes', localClasses);
                        db.setServer('students', localStudents);
                        db.setServer('attendance', localAttendance);
                        
                        const serverClasses = db.getServer('classes');
                        const serverStudents = db.getServer('students');
                        const serverAttendance = db.getServer('attendance');
                        db.setLocal('classes', serverClasses);
                        db.setLocal('students', serverStudents);
                        db.setLocal('attendance', serverAttendance);

                        syncStatus.textContent = `Synced: ${new Date().toLocaleTimeString()}`;
                        showToast('Data synced successfully!');
                        renderHomeScreen();
                    } catch (error) {
                        syncStatus.textContent = 'Sync failed. Try again.';
                        showToast('An error occurred during sync.');
                        console.error("Sync error:", error);
                    } finally {
                        syncBtn.disabled = false;
                    }
                }, 1500);
            }

            function handleDeleteStudent() {
                let students = db.getLocal('students');
                let attendance = db.getLocal('attendance');
                
                students = students.filter(s => s.id !== studentToDeleteId);
                attendance = attendance.filter(a => a.student_id !== studentToDeleteId);

                db.setLocal('students', students);
                db.setLocal('attendance', attendance);

                hideModals();
                showToast('Student deleted successfully!');
                renderManagementScreen(currentClassId);
            }

            function handleDeleteClass() {
                let classes = db.getLocal('classes');
                let students = db.getLocal('students');
                let attendance = db.getLocal('attendance');
                
                const studentIdsToDelete = students
                    .filter(s => s.class_id === classToDeleteId)
                    .map(s => s.id);
                
                classes = classes.filter(c => c.id !== classToDeleteId);
                students = students.filter(s => s.class_id !== classToDeleteId);
                attendance = attendance.filter(a => !studentIdsToDelete.includes(a.student_id));
                
                db.setLocal('classes', classes);
                db.setLocal('students', students);
                db.setLocal('attendance', attendance);
                
                hideModals();
                showToast('Class deleted successfully!');
                renderHomeScreen();
            }
            
            function handleAddClass(e) {
                e.preventDefault();
                const classNameInput = document.getElementById('newClassName');
                const className = classNameInput.value.trim();
                if (className) {
                    const classes = db.getLocal('classes');
                    classes.push({ id: Date.now(), name: className });
                    db.setLocal('classes', classes);
                    showToast('Class added successfully!');
                    classNameInput.value = '';
                    hideModals();
                    renderHomeScreen();
                }
            }
            function handleAddStudent(e) {
                e.preventDefault();
                const studentNameInput = document.getElementById('newStudentName');
                const studentRollInput = document.getElementById('newStudentRoll');
                const studentName = studentNameInput.value.trim();
                const studentRoll = parseInt(studentRollInput.value);

                if (studentName && studentRoll > 0) {
                    const allStudents = db.getLocal('students');
                    const studentsInClass = allStudents.filter(s => s.class_id === currentClassId);
                    
                    const isDuplicate = studentsInClass.some(student => student.roll_number === studentRoll);

                    if (isDuplicate) {
                        showToast('Error: This roll number already exists in this class.');
                        return; 
                    }

                    allStudents.push({ id: Date.now(), name: studentName, roll_number: studentRoll, class_id: currentClassId });
                    db.setLocal('students', allStudents);
                    showToast('Student added successfully!');
                    studentNameInput.value = '';
                    studentRollInput.value = '';
                    hideModals();
                    renderManagementScreen(currentClassId);
                }
            }
            function saveAttendance() {
                saveAttendanceBtn.disabled = true;
                saveAttendanceBtn.textContent = 'SAVING...';
                
                const checkboxes = attendanceStudentList.querySelectorAll('input[type="checkbox"]');
                const selectedDate = attendanceDateEl.value;
                let allAttendance = db.getLocal('attendance');
                const studentIdsInClass = Array.from(checkboxes).map(cb => parseInt(cb.dataset.studentId));
                
                allAttendance = allAttendance.filter(att => !(att.date === selectedDate && studentIdsInClass.includes(att.student_id)));

                checkboxes.forEach(cb => {
                    allAttendance.push({
                        student_id: parseInt(cb.dataset.studentId),
                        date: selectedDate,
                        status: cb.checked ? 'Present' : 'Absent'
                    });
                });

                db.setLocal('attendance', allAttendance);

                setTimeout(() => {
                    saveAttendanceBtn.disabled = false;
                    saveAttendanceBtn.textContent = 'SAVE ATTENDANCE';
                    showToast('Attendance saved successfully!');
                    navigateTo('home');
                }, 1000);
            }

            function showToast(message) {
                toastEl.textContent = message;
                toastEl.classList.add('show');
                setTimeout(() => toastEl.classList.remove('show'), 3000);
            }

            // --- Event Listeners ---
            function showManagementScreen(classId) {
                navigateTo('management', classId);
                renderManagementScreen(classId);
            }
            
            showSignUpLink.onclick = () => {
                loginContainer.style.display = 'none';
                signUpContainer.style.display = 'block';
            };
            showLoginLink.onclick = () => {
                signUpContainer.style.display = 'none';
                loginContainer.style.display = 'block';
            };
            
            attendanceDateEl.onchange = () => {
                renderAttendanceScreen(currentClassId, attendanceDateEl.value);
            };

            document.querySelectorAll('.back-button').forEach(btn => btn.addEventListener('click', (e) => {
                const currentScreen = e.target.closest('.screen');
                if (currentScreen.id === 'reportScreen') {
                   navigateTo('management', currentClassId);
                   renderManagementScreen(currentClassId);
                } else if (currentScreen.id === 'managementScreen' || currentScreen.id === 'attendanceScreen') {
                   navigateTo('home');
                }
            }));
            
            loginForm.onsubmit = handleLogin;
            signUpForm.onsubmit = handleSignUp;
            logoutBtn.onclick = handleLogout;
            syncBtn.onclick = handleSync;
            document.getElementById('addClassBtn').onclick = () => showModal('addClass');
            document.getElementById('addFirstClassBtn').onclick = () => showModal('addClass');
            document.getElementById('addStudentBtn').onclick = () => showModal('addStudent');
            document.getElementById('cancelAddClass').onclick = hideModals;
            document.getElementById('cancelAddStudent').onclick = hideModals;
            document.getElementById('cancelDeleteStudent').onclick = hideModals;
            document.getElementById('confirmDeleteStudentBtn').onclick = handleDeleteStudent;
            document.getElementById('cancelDeleteClass').onclick = hideModals;
            document.getElementById('confirmDeleteClassBtn').onclick = handleDeleteClass;
            document.getElementById('closeGeminiModal').onclick = hideModals;
            
            copyGeminiResultBtn.onclick = () => {
                const textToCopy = geminiResultContent.textContent;
                const copyHelper = document.getElementById('copyHelper');
                copyHelper.value = textToCopy;
                copyHelper.select();
                document.execCommand('copy');
                showToast("Text copied to clipboard!");
            };

            addClassForm.onsubmit = handleAddClass;
            addStudentForm.onsubmit = handleAddStudent;
            saveAttendanceBtn.onclick = saveAttendance;

        });
    </script>
</body>
</html>

